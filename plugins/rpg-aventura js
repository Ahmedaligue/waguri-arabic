// cÃ³digo creado por Rufino

import fetch from 'node-fetch'

let handler = async (m, { conn, usedPrefix, command }) => {
  const user = global.db.data.users[m.sender]
  
  // Inicializar datos RPG
  if (!user.rpg) {
    user.rpg = {
      coins: 1000,
      lastAdventure: 0,
      currentLocation: 0,
      stamina: 100
    }
  }
  
  // Cooldown de 5 minutos
  const COOLDOWN = 5 * 60 * 1000
  const now = Date.now()
  
  if (user.rpg.lastAdventure && (now - user.rpg.lastAdventure) < COOLDOWN) {
    const minutesLeft = Math.ceil((COOLDOWN - (now - user.rpg.lastAdventure)) / 60000)
    return m.reply(`â³ Espera ${minutesLeft} minuto(s) para la prÃ³xima aventura.`)
  }
  
  // Verificar stamina
  if (user.rpg.stamina < 20) {
    return m.reply(`ğŸ˜´ Sin energÃ­a (${user.rpg.stamina}/100). Descansa un rato.`)
  }
  
  // Fotos de aventuras (en orden)
  const adventurePhotos = [
    'https://cdn.hostrta.win/fl/v38b.jpg',
    'https://cdn.hostrta.win/fl/rxqw.jpg',
    'https://cdn.hostrta.win/fl/8n0y.jpg',
    'https://cdn.hostrta.win/fl/nc0j.jpg',
    'https://cdn.hostrta.win/fl/nyc2.jpg',
    'https://cdn.hostrta.win/fl/ubee.jpg',
    'https://cdn.hostrta.win/fl/woow.jpg',
    'https://cdn.hostrta.win/fl/aroo.jpg',
    'https://cdn.hostrta.win/fl/6e2s.jpg'
  ]
  
  // Aventuras (en orden)
  const adventures = [
    { name: 'ğŸï¸ Valle de los Susurros', reward: 150, difficulty: 'FÃ¡cil', stamina: 20 },
    { name: 'ğŸ”ï¸ MontaÃ±as Eternas', reward: 200, difficulty: 'Moderada', stamina: 25 },
    { name: 'ğŸŒ‹ VolcÃ¡n Ardiente', reward: 250, difficulty: 'DifÃ­cil', stamina: 30 },
    { name: 'ğŸ° Ruinas Prohibidas', reward: 180, difficulty: 'Moderada', stamina: 22 },
    { name: 'ğŸŒŠ Isla del Naufragio', reward: 220, difficulty: 'DifÃ­cil', stamina: 28 },
    { name: 'ğŸŒŒ Bosque Encantado', reward: 160, difficulty: 'FÃ¡cil', stamina: 18 },
    { name: 'ğŸœï¸ Desierto del Olvido', reward: 190, difficulty: 'Moderada', stamina: 24 },
    { name: 'â„ï¸ Glaciar Eterno', reward: 240, difficulty: 'DifÃ­cil', stamina: 32 },
    { name: 'âš¡ Tormenta Celestial', reward: 300, difficulty: 'Extrema', stamina: 35 }
  ]
  
  // Obtener aventura actual (en orden circular)
  const adventureIndex = user.rpg.currentLocation % adventures.length
  const adventure = adventures[adventureIndex]
  const photoUrl = adventurePhotos[adventureIndex]
  
  // Actualizar para prÃ³xima aventura
  user.rpg.currentLocation = (user.rpg.currentLocation + 1) % adventures.length
  
  // Consumir stamina
  user.rpg.stamina -= adventure.stamina
  user.rpg.lastAdventure = now
  
  // Determinar resultado (70% Ã©xito, 30% fracaso)
  const isSuccess = Math.random() < 0.7
  
  // Recompensa base
  let coinsEarned = adventure.reward
  
  // Finales diferentes
  let resultMessage = ''
  
  if (isSuccess) {
    // Ã‰XITO (4 finales diferentes)
    const successEndings = [
      {
        title: 'ğŸ† Victoria Total',
        story: 'Derrotas a todos los enemigos sin problemas. Tu habilidad es impresionante.',
        bonus: 1.5
      },
      {
        title: 'ğŸ–ï¸ Victoria con Honra',
        story: 'Ganas la batalla tras un combate intenso. Sales con algunas heridas leves.',
        bonus: 1.2
      },
      {
        title: 'âœ¨ Victoria MÃ¡gica',
        story: 'Usas hechizos y estrategia para vencer sin usar fuerza bruta.',
        bonus: 1.3
      },
      {
        title: 'ğŸ€ Victoria Afortunada',
        story: 'La suerte estÃ¡ de tu lado. Eventos inesperados te ayudan a ganar.',
        bonus: 1.4
      }
    ]
    
    const ending = successEndings[Math.floor(Math.random() * successEndings.length)]
    coinsEarned = Math.floor(coinsEarned * ending.bonus)
    user.rpg.coins += coinsEarned
    
    resultMessage = 
      `âœ… *${ending.title}*\n\n` +
      `${ending.story}\n\n` +
      `ğŸ’° *Recompensa:* ${coinsEarned} monedas\n` +
      `ğŸ’ª *EnergÃ­a usada:* ${adventure.stamina}\n` +
      `ğŸ’µ *Monedas totales:* ${user.rpg.coins}\n` +
      `âš¡ *EnergÃ­a restante:* ${user.rpg.stamina}/100`
      
  } else {
    // FRACASO (4 finales diferentes)
    const failureEndings = [
      {
        title: 'ğŸ’€ Derrota Total',
        story: 'Los enemigos te superan completamente. Debes huir para salvar tu vida.',
        penalty: 0.5
      },
      {
        title: 'ğŸ˜” Derrota por Pocos',
        story: 'Estuviste cerca de ganar, pero un error te costÃ³ la victoria.',
        penalty: 0.3
      },
      {
        title: 'ğŸŒ§ï¸ Derrota por Clima',
        story: 'El clima se vuelve en tu contra, forzÃ¡ndote a retirarte.',
        penalty: 0.2
      },
      {
        title: 'ğŸ”„ Retirada EstratÃ©gica',
        story: 'Decides retirarte sabiamente para vivir y luchar otro dÃ­a.',
        penalty: 0.1
      }
    ]
    
    const ending = failureEndings[Math.floor(Math.random() * failureEndings.length)]
    const coinsLost = Math.floor(adventure.reward * ending.penalty)
    coinsEarned = -coinsLost
    
    // No perder monedas, solo no ganar
    resultMessage = 
      `âŒ *${ending.title}*\n\n` +
      `${ending.story}\n\n` +
      `ğŸ’” *Recompensa perdida:* ${coinsLost} monedas\n` +
      `ğŸ’ª *EnergÃ­a usada:* ${adventure.stamina}\n` +
      `ğŸ’µ *Monedas totales:* ${user.rpg.coins}\n` +
      `âš¡ *EnergÃ­a restante:* ${user.rpg.stamina}/100\n\n` +
      `ğŸ’¡ *Consejo:* Descansa para recuperar energÃ­a`
  }
  
  try {
    // Enviar foto con informaciÃ³n de la aventura
    await conn.sendFile(m.chat, photoUrl, 'aventura.jpg', 
      `ğŸŒ„ *AVENTURA RPG* ğŸŒ„\n\n` +
      `ğŸ“ *Lugar:* ${adventure.name}\n` +
      `âš”ï¸ *Dificultad:* ${adventure.difficulty}\n` +
      `ğŸ’° *Recompensa potencial:* ${adventure.reward} monedas\n` +
      `ğŸ’ª *EnergÃ­a requerida:* ${adventure.stamina}\n\n` +
      `ğŸƒâ€â™‚ï¸ *Â¡Iniciando aventura...*`,
    m)
    
    // Esperar 2 segundos y mostrar resultado
    await new Promise(resolve => setTimeout(resolve, 2000))
    
    await m.reply(resultMessage)
    
    // Mostrar prÃ³xima aventura
    const nextIndex = user.rpg.currentLocation % adventures.length
    const nextAdventure = adventures[nextIndex]
    
    await new Promise(resolve => setTimeout(resolve, 1000))
    
    await m.reply(
      `ğŸ—ºï¸ *PRÃ“XIMA AVENTURA:*\n\n` +
      `ğŸ“ ${nextAdventure.name}\n` +
      `âš”ï¸ ${nextAdventure.difficulty}\n` +
      `ğŸ’° ${nextAdventure.reward} monedas\n\n` +
      `â° *Disponible en:* 5 minutos\n` +
      `ğŸ”§ *Usa:* ${usedPrefix}aventura`
    )
    
  } catch (error) {
    console.log('Error:', error)
    // Si falla la foto, enviar solo texto
    await m.reply(
      `ğŸŒ„ *AVENTURA: ${adventure.name}*\n\n` +
      resultMessage + `\n\n` +
      `â° *PrÃ³xima aventura en:* 5 minutos`
    )
  }
}

handler.help = ['aventura']
handler.tags = ['rpg']
handler.command = /^(aventura|adventure)$/i
handler.group = true
handler.register = true

export default handler